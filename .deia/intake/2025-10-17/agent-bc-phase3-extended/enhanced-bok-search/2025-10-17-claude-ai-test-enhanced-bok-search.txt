import json
import pytest
from enhanced_bok_search import EnhancedBOKSearch, SearchResult

# Test data
@pytest.fixture
def sample_bok_index():
    return [
        {
            "id": "1",
            "title": "Python List Comprehension",
            "content": "A concise way to create lists in Python",
            "summary": "List comprehensions provide a shorter syntax for creating lists.",
            "path": "python/list_comprehension.md"
        },
        {
            "id": "2",
            "title": "Python Generators",
            "content": "Generators are a simple way to create iterators in Python",
            "summary": "Generators can be created with generator expressions or generator functions.",
            "path": "python/generators.md"
        },
        {
            "id": "3",
            "title": "Python Decorators",
            "content": "Decorators are a way to modify or enhance functions in Python",
            "summary": "Decorators can be used to add functionality to functions without modifying their code.",
            "path": "python/decorators.md"
        }
    ]

@pytest.fixture
def bok_search(tmp_path, sample_bok_index):
    index_file = tmp_path / "test_index.json"
    with open(index_file, "w") as f:
        json.dump(sample_bok_index, f)
    return EnhancedBOKSearch(str(index_file))

# Test cases
def test_search_results(bok_search):
    query = "Python list"
    results = bok_search.search(query)

    assert len(results) == 1
    assert isinstance(results[0], SearchResult)
    assert results[0].title == "Python List Comprehension"

def test_search_empty_query(bok_search):
    query = ""
    results = bok_search.search(query)

    assert len(results) == 0

def test_search_no_matches(bok_search):
    query = "Non-existent topic"
    results = bok_search.search(query)

    assert len(results) == 0

def test_fuzzy_search(bok_search):
    query = "PYthon list comprEhension"
    results = bok_search.fuzzy_search(query)

    assert len(results) == 1
    assert results[0].title == "Python List Comprehension"

def test_fuzzy_search_threshold(bok_search):
    query = "PYthon list comprEhension"
    results = bok_search.fuzzy_search(query, threshold=0.9)

    assert len(results) == 0

def test_find_related(bok_search):
    pattern_id = "1"
    related_patterns = bok_search.find_related(pattern_id)

    assert len(related_patterns) == 2
    assert "2" in related_patterns
    assert "3" in related_patterns

def test_find_related_invalid_id(bok_search):
    pattern_id = "999"
    related_patterns = bok_search.find_related(pattern_id)

    assert len(related_patterns) == 0
